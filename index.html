<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline Futures Trading Calculator</title>
    <style>
        /* General Reset & Typography */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); /* Dark gradient background */
            color: #e2e8f0;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }

        /* Container and Layout */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            gap: 20px;
            grid-template-columns: 1fr;
        }

        /* Desktop Layout (Multi-panel grid) */
        @media (min-width: 1024px) {
            .container {
                grid-template-columns: 1fr 1fr 1fr;
                grid-template-rows: auto auto 1fr;
            }
            .instrument-section {
                grid-column: 1 / 2;
                grid-row: 1 / 2;
            }
            .risk-calculator {
                grid-column: 2 / 3;
                grid-row: 1 / 2;
            }
            .pnl-calculator {
                grid-column: 3 / 4;
                grid-row: 1 / 2;
            }
            .journal-section {
                grid-column: 1 / 4;
                grid-row: 2 / 3;
            }
            .disclaimer-section {
                grid-column: 1 / 4;
                grid-row: 3 / 4;
            }
        }

        /* Cards/Panels */
        .card {
            background-color: #1f2937;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            border: 1px solid #334155;
            transition: transform 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4);
        }

        h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #93c5fd;
            border-bottom: 2px solid #334155;
            padding-bottom: 10px;
        }

        /* Input Styles */
        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #cbd5e1;
            font-weight: 500;
        }

        input[type="number"], input[type="text"], select {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #475569;
            background-color: #334155;
            color: #e2e8f0;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input[type="number"]:focus, input[type="text"]:focus, select:focus {
            border-color: #60a5fa;
            outline: none;
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.5);
        }

        /* Output Display */
        .output-panel {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background-color: #0f172a;
            border: 1px solid #1e293b;
        }

        .output-panel p {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .output-panel p strong {
            color: #a7f3d0;
            font-weight: 600;
        }

        .output-panel p.highlight strong {
            color: #fcd34d;
            font-size: 1.1rem;
        }

        /* Button Styles */
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 10px 15px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
        }

        .btn-primary {
            background: linear-gradient(90deg, #60a5fa, #3b82f6);
            color: #ffffff;
            box-shadow: 0 2px 5px rgba(59, 130, 246, 0.4);
        }

        .btn-primary:hover {
            background: linear-gradient(90deg, #3b82f6, #60a5fa);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: #475569;
            color: #e2e8f0;
            border: 1px solid #64748b;
        }

        .btn-secondary:hover {
            background-color: #64748b;
        }

        /* Trade Journal Table */
        .journal-container {
            overflow-x: auto;
        }

        .journal-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.85rem;
        }

        .journal-table th, .journal-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #334155;
        }

        .journal-table th {
            background-color: #334155;
            color: #93c5fd;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 700;
            position: sticky;
            top: 0;
        }

        .journal-table tbody tr:hover {
            background-color: #1e293b;
        }

        .summary-row td {
            background-color: #0f172a;
            font-weight: bold;
            color: #a7f3d0;
            border-top: 2px solid #60a5fa;
        }

        /* Disclaimers */
        .disclaimer-section {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #334155;
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .disclaimer-section p {
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .disclaimer-section hr {
            border: 0;
            height: 1px;
            background-color: #334155;
            margin: 15px 0;
        }

    </style>
</head>
<body>

    <div class="container">
        <!-- Instrument Selector and Specs -->
        <section class="card instrument-section">
            <h2>Instrument & Margin</h2>
            <div class="input-group">
                <label for="instrument-select">Select Instrument</label>
                <select id="instrument-select"></select>
            </div>

            <div class="output-panel">
                <p>Exchange: <strong id="spec-exchange">N/A</strong></p>
                <p>Tick Size: <strong id="spec-tick-size">N/A</strong></p>
                <p>Tick Value: <strong id="spec-tick-value">N/A</strong></p>
                <p>Point Value: <strong id="spec-point-value">N/A</strong></p>
                <p class="highlight">Margin/Contract: <strong id="spec-margin">N/A</strong></p>
                <p>Leverage: <strong id="output-leverage">0x</strong></p>
            </div>

            <h3 style="margin-top: 20px; color: #cbd5e1; font-size: 1.2rem; border-bottom: 1px solid #334155; padding-bottom: 5px;">Custom Instrument</h3>
            <div id="custom-instrument-form">
                <div class="input-group"><input type="text" id="custom-name" placeholder="Name (e.g., CUS)"></div>
                <div class="input-group"><input type="number" id="custom-tick-size" placeholder="Tick Size (e.g., 0.25)" step="any"></div>
                <div class="input-group"><input type="number" id="custom-tick-value" placeholder="Tick Value (e.g., 12.50)" step="any"></div>
                <div class="input-group"><input type="number" id="custom-multiplier" placeholder="Point Value (Multiplier)" step="any"></div>
                <div class="input-group"><input type="number" id="custom-margin" placeholder="Margin (e.g., 12000)" step="any"></div>
                <div class="button-group">
                    <button class="btn btn-secondary" onclick="addCustomInstrument()">Add Custom</button>
                </div>
            </div>

        </section>

        <!-- Position Size & Risk Calculator -->
        <section class="card risk-calculator">
            <h2>Position Size & Risk</h2>
            <div class="input-group">
                <label for="account-balance">Account Balance ($)</label>
                <input type="number" id="account-balance" value="25000" min="0" step="100" oninput="updateCalculators()">
            </div>
            <div class="input-group">
                <label for="risk-percent">Risk Percentage (%)</label>
                <input type="number" id="risk-percent" value="1.0" min="0.01" max="100" step="0.1" oninput="updateCalculators()">
            </div>
            <div class="input-group">
                <label for="stop-ticks">Stop Loss (Ticks)</label>
                <input type="number" id="stop-ticks" value="16" min="1" step="1" oninput="updateCalculators()">
            </div>

            <div class="output-panel">
                <p>Dollar Risk/Trade: <strong id="output-dollar-risk">$0.00</strong></p>
                <p>Stop Loss (Points): <strong id="output-point-risk">0.00</strong></p>
                <p>Stop Loss (Ticks): <strong id="output-tick-risk">0</strong></p>
                <p class="highlight">Max Contracts: <strong id="output-max-contracts">0</strong></p>
            </div>
        </section>

        <!-- P&L and Simulation Calculator -->
        <section class="card pnl-calculator">
            <h2>P&L & Simulation</h2>
            <div class="input-group">
                <label for="entry-price">Entry Price</label>
                <input type="number" id="entry-price" value="4500.00" step="any" oninput="updateCalculators()">
            </div>
            <div class="input-group">
                <label for="exit-price">Exit Price</label>
                <input type="number" id="exit-price" value="4510.00" step="any" oninput="updateCalculators()">
            </div>
            <div class="input-group">
                <label for="num-contracts">Number of Contracts</label>
                <input type="number" id="num-contracts" value="1" min="1" step="1" oninput="updateCalculators()">
            </div>
            <div class="input-group">
                <label for="commission">Commission (per contract, round trip)</label>
                <input type="number" id="commission" value="4.00" min="0" step="0.01" oninput="updateCalculators()">
            </div>

            <h3 style="margin-top: 10px; color: #cbd5e1; font-size: 1.1rem;">Trade Outcomes</h3>
            <div class="input-group">
                <label for="target-price">Target Price (Optional)</label>
                <input type="number" id="target-price" value="4520.00" step="any" oninput="updateCalculators()">
            </div>
            <div class="input-group">
                <label for="stop-price">Stop Price (Optional)</label>
                <input type="number" id="stop-price" value="4495.00" step="any" oninput="updateCalculators()">
            </div>


            <div class="output-panel">
                <p>Gross P&L ($): <strong id="output-gross-pnl">$0.00</strong></p>
                <p>Net P&L ($): <strong id="output-net-pnl">$0.00</strong></p>
                <p>P&L (Points): <strong id="output-pnl-points">0.00</strong></p>
                <p>P&L (Ticks): <strong id="output-pnl-ticks">0</strong></p>
                <hr style="border: 0; height: 1px; background-color: #475569; margin: 10px 0;">
                <p class="highlight">Risk-to-Reward (R:R): <strong id="output-rr">0.00:1</strong></p>
            </div>
            <div class="button-group">
                <button class="btn btn-primary" onclick="addTradeToJournal()">Add Trade to Journal</button>
            </div>
        </section>

        <!-- Trade Journal -->
        <section class="card journal-section">
            <h2>Trade Journal (Session Data)</h2>
            <div class="button-group">
                <button class="btn btn-secondary" onclick="exportJournal('csv')">Export CSV</button>
                <button class="btn btn-secondary" onclick="exportJournal('txt')">Export TXT</button>
                <button class="btn btn-secondary" onclick="exportJournal('json')">Export JSON</button>
                <button class="btn btn-secondary" onclick="exportJournal('pdf')">Export PDF (Simple)</button>
                <button class="btn btn-secondary" onclick="clearJournal()">Clear Journal</button>
                <button class="btn btn-secondary" onclick="resetAll()">Reset All</button>
            </div>

            <div class="journal-container">
                <table class="journal-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Instrument</th>
                            <th>Qty</th>
                            <th>Entry</th>
                            <th>Exit</th>
                            <th>Stop</th>
                            <th>Target</th>
                            <th>R:R</th>
                            <th>Net P&L ($)</th>
                            <th>Comms ($)</th>
                        </tr>
                    </thead>
                    <tbody id="journal-body">
                        <!-- Trades will be inserted here -->
                    </tbody>
                    <tfoot>
                        <tr class="summary-row">
                            <td colspan="7">TOTALS/AVERAGE</td>
                            <td id="summary-avg-rr">Avg R:R: 0.00</td>
                            <td id="summary-total-pnl">Total P&L: $0.00</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </section>

        <!-- Disclaimers -->
        <section class="disclaimer-section">
            <p>HYPOTHETICAL OR SIMULATED PERFORMANCE RESULTS HAVE CERTAIN INHERENT LIMITATIONS. UNLIKE AN ACTUAL PERFORMANCE RECORD, SIMULATED RESULTS DO NOT REPRESENT ACTUAL TRADING. ALSO, SINCE THE TRADES HAVE NOT BEEN EXECUTED, THE RESULTS MAY HAVE UNDER-OR-OVER COMPENSATED FOR THE IMPACT, IF ANY, OF CERTAIN MARKET FACTORS, SUCH AS LACK OF LIQUIDITY. SIMULATED TRADING PROGRAMS IN GENERAL ARE ALSO SUBJECT TO THE FACT THAT THEY ARE DESIGNED WITH THE BENEFIT OF HINDSIGHT. NO REPRESENTATION IS BEING MADE THAT ANY ACCOUNT WILL OR IS LIKELY TO ACHIEVE PROFIT OR LOSSES SIMILAR TO THOSE SHOWN.</p>
            <hr>
            <p>All calculations and trade data exist only in your browser’s memory. Nothing is saved or transmitted. Refreshing or closing the page will permanently clear all data. This website does not provide financial, investment, or trading advice. Use of any information or tools on this site is entirely at your own risk.</p>
        </section>

    </div>

    <script>
        const BUILT_IN_INSTRUMENTS = {
            'ES': { tickSize: 0.25, tickValue: 12.50, contractMultiplier: 50, margin: 12000, exchange: 'CME' },
            'MES': { tickSize: 0.25, tickValue: 1.25, contractMultiplier: 5, margin: 1200, exchange: 'CME' },
            'NQ': { tickSize: 0.25, tickValue: 5.00, contractMultiplier: 20, margin: 15000, exchange: 'CME' },
            'MNQ': { tickSize: 0.25, tickValue: 0.50, contractMultiplier: 2, margin: 1500, exchange: 'CME' },
            'YM': { tickSize: 1.00, tickValue: 5.00, contractMultiplier: 5, margin: 5000, exchange: 'CBOT' },
            'MYM': { tickSize: 1.00, tickValue: 0.50, contractMultiplier: 0.5, margin: 500, exchange: 'CBOT' },
            'RTY': { tickSize: 0.10, tickValue: 5.00, contractMultiplier: 10, margin: 7500, exchange: 'CME' },
            'M2K': { tickSize: 0.10, tickValue: 0.50, contractMultiplier: 1, margin: 750, exchange: 'CME' },
            'GC': { tickSize: 0.10, tickValue: 10.00, contractMultiplier: 100, margin: 8000, exchange: 'COMEX' },
            'MGC': { tickSize: 0.10, tickValue: 1.00, contractMultiplier: 10, margin: 800, exchange: 'COMEX' },
            'SI': { tickSize: 0.005, tickValue: 25.00, contractMultiplier: 5000, margin: 10000, exchange: 'COMEX' },
            'SIL': { tickSize: 0.005, tickValue: 5.00, contractMultiplier: 1000, margin: 2000, exchange: 'COMEX' },
            'CL': { tickSize: 0.01, tickValue: 10.00, contractMultiplier: 1000, margin: 11000, exchange: 'NYMEX' },
            'MCL': { tickSize: 0.01, tickValue: 1.00, contractMultiplier: 100, margin: 1100, exchange: 'NYMEX' },
            'NG': { tickSize: 0.001, tickValue: 10.00, contractMultiplier: 10000, margin: 4000, exchange: 'NYMEX' },
            'ZB': { tickSize: 0.01, tickValue: 31.25, contractMultiplier: 1000, margin: 2500, exchange: 'CBOT' },
            '6E': { tickSize: 0.00005, tickValue: 6.25, contractMultiplier: 125000, margin: 1500, exchange: 'CME' }
        };

        let currentInstruments = {...BUILT_IN_INSTRUMENTS};
        let tradeJournal = [];

        function initInstrumentSelector() {
            const select = document.getElementById('instrument-select');
            select.innerHTML = '';
            const allSymbols = Object.keys(currentInstruments).sort();

            allSymbols.forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                option.textContent = symbol;
                select.appendChild(option);
            });

            select.onchange = updateCalculators;
            select.value = 'ES'; // Set default selection
            updateCalculators();
        }

        function getInstrument() {
            const selectedSymbol = document.getElementById('instrument-select').value;
            return currentInstruments[selectedSymbol];
        }

        function updateInstrumentSpecs(inst) {
            if (!inst) {
                document.getElementById('spec-exchange').textContent = 'N/A';
                document.getElementById('spec-tick-size').textContent = 'N/A';
                document.getElementById('spec-tick-value').textContent = 'N/A';
                document.getElementById('spec-point-value').textContent = 'N/A';
                document.getElementById('spec-margin').textContent = 'N/A';
                return;
            }

            document.getElementById('spec-exchange').textContent = inst.exchange || 'N/A';
            document.getElementById('spec-tick-size').textContent = inst.tickSize.toFixed(Math.max(2, inst.tickSize.toString().split('.')[1]?.length || 0));
            document.getElementById('spec-tick-value').textContent = `$${inst.tickValue.toFixed(2)}`;
            document.getElementById('spec-point-value').textContent = `$${inst.contractMultiplier.toFixed(2)}`;
            document.getElementById('spec-margin').textContent = `$${inst.margin.toLocaleString()}`;
        }

        function addCustomInstrument() {
            const name = document.getElementById('custom-name').value.toUpperCase().trim();
            const tickSize = parseFloat(document.getElementById('custom-tick-size').value);
            const tickValue = parseFloat(document.getElementById('custom-tick-value').value);
            const multiplier = parseFloat(document.getElementById('custom-multiplier').value);
            const margin = parseFloat(document.getElementById('custom-margin').value);

            if (!name || isNaN(tickSize) || isNaN(tickValue) || isNaN(multiplier) || isNaN(margin) || tickSize <= 0 || tickValue <= 0 || multiplier <= 0 || margin <= 0) {
                alert('Please enter valid, positive values for all custom instrument fields.');
                return;
            }

            currentInstruments[name] = {
                tickSize: tickSize,
                tickValue: tickValue,
                contractMultiplier: multiplier,
                margin: margin,
                exchange: 'CUSTOM'
            };

            initInstrumentSelector();
            document.getElementById('instrument-select').value = name;
            updateCalculators();

            // Clear custom form
            document.getElementById('custom-name').value = '';
            document.getElementById('custom-tick-size').value = '';
            document.getElementById('custom-tick-value').value = '';
            document.getElementById('custom-multiplier').value = '';
            document.getElementById('custom-margin').value = '';
        }

        function calculatePositionAndRisk(inst) {
            const balance = parseFloat(document.getElementById('account-balance').value);
            const riskPercent = parseFloat(document.getElementById('risk-percent').value);
            const stopTicks = parseFloat(document.getElementById('stop-ticks').value);

            if (!inst || isNaN(balance) || isNaN(riskPercent) || isNaN(stopTicks) || balance <= 0 || riskPercent <= 0 || stopTicks <= 0) {
                document.getElementById('output-dollar-risk').textContent = '$0.00';
                document.getElementById('output-point-risk').textContent = '0.00';
                document.getElementById('output-tick-risk').textContent = '0';
                document.getElementById('output-max-contracts').textContent = '0';
                return { dollarRisk: 0, maxContracts: 0, pointRisk: 0 };
            }

            const dollarRiskPerContract = stopTicks * inst.tickValue;
            const maxDollarRisk = balance * (riskPercent / 100);
            const maxContracts = dollarRiskPerContract > 0 ? Math.floor(maxDollarRisk / dollarRiskPerContract) : 0;
            const actualDollarRisk = maxContracts * dollarRiskPerContract;
            const pointRisk = stopTicks * inst.tickSize;

            document.getElementById('output-dollar-risk').textContent = `$${maxDollarRisk.toFixed(2)}`;
            document.getElementById('output-point-risk').textContent = pointRisk.toFixed(4);
            document.getElementById('output-tick-risk').textContent = stopTicks.toFixed(0);
            document.getElementById('output-max-contracts').textContent = maxContracts.toFixed(0);

            return { dollarRisk: maxDollarRisk, maxContracts: maxContracts, pointRisk: pointRisk };
        }

        function calculatePnLAndRR(inst) {
            const entryPrice = parseFloat(document.getElementById('entry-price').value);
            const exitPrice = parseFloat(document.getElementById('exit-price').value);
            const contracts = parseInt(document.getElementById('num-contracts').value);
            const commission = parseFloat(document.getElementById('commission').value);
            const stopPrice = parseFloat(document.getElementById('stop-price').value);
            const targetPrice = parseFloat(document.getElementById('target-price').value);

            let grossPnL = 0;
            let pnlTicks = 0;
            let pnlPoints = 0;
            let netPnL = 0;

            if (inst && !isNaN(entryPrice) && !isNaN(exitPrice) && contracts > 0 && !isNaN(commission) && commission >= 0) {
                pnlPoints = exitPrice - entryPrice;
                pnlTicks = Math.round(pnlPoints / inst.tickSize);
                grossPnL = pnlTicks * inst.tickValue * contracts;
                netPnL = grossPnL - (commission * contracts);
            }

            document.getElementById('output-gross-pnl').textContent = `$${grossPnL.toFixed(2)}`;
            document.getElementById('output-net-pnl').textContent = `$${netPnL.toFixed(2)}`;
            document.getElementById('output-pnl-points').textContent = pnlPoints.toFixed(4);
            document.getElementById('output-pnl-ticks').textContent = pnlTicks.toFixed(0);

            let rr = 0;
            let targetGain = 0;
            let stopLoss = 0;

            if (inst && !isNaN(targetPrice) && !isNaN(stopPrice) && !isNaN(entryPrice) && contracts > 0) {
                // Determine if Long or Short
                if (targetPrice > entryPrice && stopPrice < entryPrice) { // Assumed Long Trade
                    targetGain = (targetPrice - entryPrice) * inst.contractMultiplier;
                    stopLoss = (entryPrice - stopPrice) * inst.contractMultiplier;
                } else if (targetPrice < entryPrice && stopPrice > entryPrice) { // Assumed Short Trade
                    targetGain = (entryPrice - targetPrice) * inst.contractMultiplier;
                    stopLoss = (stopPrice - entryPrice) * inst.contractMultiplier;
                } else {
                    targetGain = 0;
                    stopLoss = 0;
                }

                if (stopLoss > 0) {
                    rr = targetGain / stopLoss;
                }
            }

            document.getElementById('output-rr').textContent = `${rr.toFixed(2)}:1`;

            return { netPnL, rr };
        }

        function updateLeverage(inst) {
            const entryPrice = parseFloat(document.getElementById('entry-price').value);
            const contracts = parseInt(document.getElementById('num-contracts').value);
            const balance = parseFloat(document.getElementById('account-balance').value);

            let leverage = 0;

            if (inst && !isNaN(entryPrice) && contracts > 0 && balance > 0) {
                // Position Value (approximate) = Price * Point Value (Multiplier) * Contracts
                const positionValue = entryPrice * inst.contractMultiplier * contracts;
                leverage = positionValue / balance;
            }

            document.getElementById('output-leverage').textContent = `${leverage.toFixed(2)}x`;
        }


        function updateCalculators() {
            const inst = getInstrument();
            updateInstrumentSpecs(inst);
            calculatePositionAndRisk(inst);
            calculatePnLAndRR(inst);
            updateLeverage(inst);
        }

        // --- Trade Journal Functions ---

        function addTradeToJournal() {
            const inst = getInstrument();
            if (!inst) return;

            const entry = parseFloat(document.getElementById('entry-price').value);
            const exit = parseFloat(document.getElementById('exit-price').value);
            const qty = parseInt(document.getElementById('num-contracts').value);
            const commission = parseFloat(document.getElementById('commission').value);
            const stop = document.getElementById('stop-price').value;
            const target = document.getElementById('target-price').value;

            if (isNaN(entry) || isNaN(exit) || qty <= 0 || isNaN(commission)) {
                alert('Please ensure Entry, Exit, Quantity, and Commission are valid for the trade.');
                return;
            }

            const { netPnL, rr } = calculatePnLAndRR(inst);
            const timestamp = new Date().toLocaleTimeString();

            const trade = {
                timestamp,
                instrument: document.getElementById('instrument-select').value,
                entry: entry.toFixed(4),
                exit: exit.toFixed(4),
                qty,
                stop: stop ? parseFloat(stop).toFixed(4) : '',
                target: target ? parseFloat(target).toFixed(4) : '',
                rr: rr.toFixed(2),
                netPnL: netPnL,
                commissions: (commission * qty).toFixed(2)
            };

            tradeJournal.unshift(trade);
            renderJournal();
        }

        function renderJournal() {
            const body = document.getElementById('journal-body');
            body.innerHTML = '';
            let totalPnL = 0;
            let totalRR = 0;

            if (tradeJournal.length === 0) {
                body.innerHTML = '<tr><td colspan="10" style="text-align: center; color: #64748b;">No trades recorded in this session.</td></tr>';
                document.getElementById('summary-total-pnl').textContent = 'Total P&L: $0.00';
                document.getElementById('summary-avg-rr').textContent = 'Avg R:R: 0.00';
                return;
            }

            tradeJournal.forEach(trade => {
                const row = body.insertRow();
                row.insertCell().textContent = trade.timestamp;
                row.insertCell().textContent = trade.instrument;
                row.insertCell().textContent = trade.qty;
                row.insertCell().textContent = trade.entry;
                row.insertCell().textContent = trade.exit;
                row.insertCell().textContent = trade.stop;
                row.insertCell().textContent = trade.target;
                row.insertCell().textContent = trade.rr;
                row.insertCell().textContent = `$${trade.netPnL.toFixed(2)}`;
                row.insertCell().textContent = `$${trade.commissions}`;

                totalPnL += trade.netPnL;
                totalRR += parseFloat(trade.rr);
            });

            const avgRR = totalRR / tradeJournal.length;
            document.getElementById('summary-total-pnl').textContent = `Total P&L: $${totalPnL.toFixed(2)}`;
            document.getElementById('summary-avg-rr').textContent = `Avg R:R: ${avgRR.toFixed(2)}`;
        }

        function clearJournal() {
            if (confirm('Are you sure you want to clear the entire trade journal? This cannot be undone.')) {
                tradeJournal = [];
                renderJournal();
            }
        }

        function resetAll() {
             if (confirm('Are you sure you want to reset all inputs and clear the journal?')) {
                // Clear Journal
                tradeJournal = [];
                renderJournal();

                // Reset Inputs (simple brute force for a one-file app)
                document.getElementById('account-balance').value = '25000';
                document.getElementById('risk-percent').value = '1.0';
                document.getElementById('stop-ticks').value = '16';
                document.getElementById('entry-price').value = '4500.00';
                document.getElementById('exit-price').value = '4510.00';
                document.getElementById('num-contracts').value = '1';
                document.getElementById('commission').value = '4.00';
                document.getElementById('target-price').value = '4520.00';
                document.getElementById('stop-price').value = '4495.00';

                // Reset custom instruments
                currentInstruments = {...BUILT_IN_INSTRUMENTS};
                initInstrumentSelector();

                updateCalculators();
            }
        }

        // --- Export Functions ---

        function exportJournal(format) {
            if (tradeJournal.length === 0) {
                alert('Journal is empty. Add a trade first.');
                return;
            }

            const header = ['Timestamp', 'Instrument', 'Qty', 'Entry', 'Exit', 'Stop', 'Target', 'R:R', 'Net P&L ($)', 'Commissions ($)'];
            const data = tradeJournal.map(trade => [
                trade.timestamp, trade.instrument, trade.qty, trade.entry, trade.exit, trade.stop, trade.target, trade.rr, trade.netPnL.toFixed(2), trade.commissions
            ]);

            const summary = [
                'TOTAL P&L', document.getElementById('summary-total-pnl').textContent.replace('Total P&L: ', ''),
                'AVG R:R', document.getElementById('summary-avg-rr').textContent.replace('Avg R:R: ', '')
            ];

            let content, mimeType, filename;

            switch (format) {
                case 'csv':
                    content = [
                        header.join(','),
                        ...data.map(row => row.join(','))
                    ].join('\n') + '\n\n' + summary.join(', ');
                    mimeType = 'text/csv';
                    filename = 'futures_journal.csv';
                    break;
                case 'txt':
                    content = 'Futures Trading Journal\n\n' +
                              header.join('\t') + '\n' +
                              data.map(row => row.join('\t')).join('\n') +
                              '\n\nSummary:\n' + summary.join(' | ');
                    mimeType = 'text/plain';
                    filename = 'futures_journal.txt';
                    break;
                case 'json':
                    content = JSON.stringify({ trades: tradeJournal, summary: { totalPnL: tradeJournal.reduce((sum, t) => sum + t.netPnL, 0), averageRR: totalRR / tradeJournal.length } }, null, 2);
                    mimeType = 'application/json';
                    filename = 'futures_journal.json';
                    break;
                case 'pdf':
                    // Simple PDF generation using a Data URI, simulating a basic document.
                    // True PDF generation is complex and requires libraries, which are forbidden.
                    content = 'data:text/html;charset=utf-8,' + encodeURIComponent(`
                        <html><head><title>Futures Journal PDF</title><style>
                        body{font-family:sans-serif;margin:40px;} table{width:100%;border-collapse:collapse;}
                        th,td{border:1px solid #000;padding:8px;text-align:left;} th{background-color:#eee;}
                        .summary{margin-top:20px;font-weight:bold;}
                        </style></head><body>
                        <h1>Futures Trading Journal</h1>
                        <table>
                            <thead><tr>${header.map(h => `<th>${h}</th>`).join('')}</tr></thead>
                            <tbody>${data.map(row => `<tr>${row.map(c => `<td>${c}</td>`).join('')}</tr>`).join('')}</tbody>
                        </table>
                        <div class="summary">
                            <p>${document.getElementById('summary-total-pnl').textContent}</p>
                            <p>${document.getElementById('summary-avg-rr').textContent}</p>
                        </div>
                        <p style="margin-top: 50px; font-size: 10px;">Disclaimer: This is a simulated performance record only.</p>
                        </body></html>
                    `);
                    mimeType = 'application/pdf'; // This will prompt the browser to print/save as PDF
                    filename = 'futures_journal.pdf';
                    
                    const printWindow = window.open('about:blank', '_blank');
                    printWindow.document.write(decodeURIComponent(content).replace('application/pdf', 'text/html'));
                    printWindow.document.close();
                    printWindow.print();
                    return; // Return early for PDF handled by print

            }

            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- Initialization ---

        window.onload = function() {
            initInstrumentSelector();
            updateCalculators();
            renderJournal();

            // Setup input listeners for auto-update (in addition to inline)
            document.querySelectorAll('input[type="number"], input[type="text"]').forEach(input => {
                input.addEventListener('input', updateCalculators);
            });
        };
    </script>
</body>
</html>
